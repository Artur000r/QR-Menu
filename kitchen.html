<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‘Ω’∏’∞’°’∂’∏÷Å’´ ’ä’°’∂’•’¨</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ‘∏’Ü‘¥’Ä‘±’Ü’à’í’ê ’à’É‘µ’ê --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        header {
            background: #1a4d2e;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 28px; }
        .order-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .order-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        
        /* --- ‘ø‘±’ê‘≥‘±’é‘ª’É‘±‘ø‘ª ’à’É‘µ’ê --- */
        .order-card.new { border-left: 8px solid #007bff; }
        .order-card.ready { border-left: 8px solid #28a745; background-color: #e6ffed; }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .table-num {
            font-size: 32px;
            font-weight: 900;
            color: #1a4d2e;
        }
        .order-time {
            font-size: 14px;
            color: #777;
            font-weight: 600;
        }
        .items-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            flex-grow: 1;
        }
        .item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 16px;
            border-bottom: 1px dashed #f1f1f1;
        }
        .item-name { font-weight: 600; }
        .item-qty { font-weight: 900; color: #dc3545; }
        .comment {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            color: #555;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }
        .action-button {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-done {
            background-color: #28a745;
            color: white;
        }
        .btn-done:hover { background-color: #218838; }
        
        /* ‘∫’°’¥’°’∂’°’Ø’°÷Å’∏÷Ç’µ÷Å’´ ’∏’≥ (Timer) */
        .timer {
            font-size: 14px;
            font-weight: bold;
            color: #777;
        }
    </style>
</head>
<body>

    <header>
        <h1>üë®‚Äçüç≥ ‘Ω’∏’∞’°’∂’∏÷Å’´ ’ä’°’ø’æ’•÷Ä’∂’•÷Ä’´ ’Ñ’°’ø’µ’°’∂</h1>
        <div id="kitchenStatus">’ç’∫’°’Ω’∏÷Ç’¥ ’ß ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’´...</div>
    </header>

    <div class="order-container" id="ordersContainer">
        </div>

    <script>
        // ==========================================
        // ‘¥‘ª’ê ’î’à FIREBASE-‘ª ’è’é’Ö‘±‘º’Ü‘µ’ê‘∏ ‘±’Ö’ç’è‘µ’Ç
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzKoNezvEjHAkz7oqR5ZT2oYIzgaKS9HA",
            authDomain: "dolmamenu.firebaseapp.com",
            projectId: "dolmamenu",
            storageBucket: "dolmamenu.firebasestorage.app",
            messagingSenderId: "79065105652",
            appId: "1:79065105652:web:58dc22269a56c6c4ca4aa1",
            measurementId: "G-QX4RMX94QC"
        };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- SaaS ‘º’à‘≥‘ª‘ø‘± ---
        const urlParams = new URLSearchParams(window.location.search);
        const restaurantId = urlParams.get('rest') || 'default_restaurant';
        const restaurantRef = db.ref('restaurants/' + restaurantId);

        // ‘º’Ω’∏÷Ç’¥ ’•’∂÷Ñ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® ’¥’´’°’µ’∂ ’°’µ’Ω ’º’•’Ω’ø’∏÷Ä’°’∂’´ ’∞’°’¥’°÷Ä
        function listenOrders() {
            restaurantRef.child('orders').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                renderOrders(data);
            });
        }

        // ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø’´ ’©’°÷Ä’¥’°÷Å’∏÷Ç’¥’® ’∂’∏÷Ç’µ’∂’∫’•’Ω ’§’°’º’∂’∏÷Ç’¥ ’ß ’§’´’∂’°’¥’´’Ø
        function updateOrderStatus(orderId, newStatus) {
            restaurantRef.child('orders/' + orderId).update({
                status_kitchen: newStatus,
                status_ready_at: newStatus === 'ready' ? Date.now() : null
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            listenForOrders();
            // ‘æ‘±’Ü’à’í’ë’à’í’Ñ’Ü‘µ’ê‘ª ‘π’à’í’Ö‘º’è’é’à’í‘π’Ö‘±’Ü ’Ä‘±’ê’ë’à’í’Ñ
            if ('Notification' in window) {
                Notification.requestPermission();
            }
        });

        // ---------------------------------------------------
        //  FIREBASE-‘ª ‘º’ç’à’Ç‘∏ (LISTENER)
        // ---------------------------------------------------

        function listenForOrders() {
            // ‘º’Ω’∏÷Ç’¥ ’•’∂÷Ñ orders ’≥’µ’∏÷Ç’≤’´ ’¢’∏’¨’∏÷Ä ÷É’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’®
            restaurantRef.child('orders').on('value', (snapshot) => {
                const orders = snapshot.val() || {};
                renderOrders(orders);
                checkNewOrder(orders);
            });
        }
        
        // ---------------------------------------------------
        //  ’Ü’à’ê ’ä‘±’è’é‘µ’ê‘ª ‘æ‘±’Ü’à’í’ë’à’í’Ñ
        // ---------------------------------------------------

        let lastOrderCount = 0;

        function checkNewOrder(orders) {
            let activeOrderCount = 0;
            for(const key in orders) {
                const order = orders[key];
                // ’Ä’°’∑’æ’∏÷Ç’¥ ’•’∂÷Ñ ’¥’´’°’µ’∂ ’°’Ø’ø’´’æ (’π÷É’°’Ø’æ’°’Æ) ’°’∫÷Ä’°’∂÷Ñ’°’µ’´’∂ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’®
                if (!order.status_kitchen_closed && order.items && !isServiceRequest(order)) {
                     activeOrderCount++;
                }
            }

            if (activeOrderCount > lastOrderCount && lastOrderCount > 0) {
                 playSound();
                 showNotification('üîî ’Ü’à’ê ’ä‘±’è’é‘µ’ê ‘Ω’à’Ä‘±’Ü’à’ë‘ª’Ü', 'kitchen');
            }
            lastOrderCount = activeOrderCount;
        }

        function isServiceRequest(order) {
            return order.items.some(item => 
                item.name.includes("’Ä‘±’á‘ª’é") || item.name.includes("‘ø‘±’Ü’â") || item.name.includes("’Ä‘±’ê’ë’Ü’à’í’Ñ")
            );
        }

        function playSound() {
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/buzz_woody.ogg');
            audio.play().catch(e=>{});
        }
        
        function showNotification(body, role) {
            if (Notification.permission === 'granted') {
                const title = '‘Ω’∏’∞’°’∂’∏÷Å PRO';
                new Notification(title, { body: body });
            }
        }


        // ---------------------------------------------------
        //  ’ä‘±’è’é‘µ’ê’Ü‘µ’ê‘ª ’ë’à’í’ë‘±‘¥’ê’à’í’Ñ
        // ---------------------------------------------------
        
        function renderOrders(allOrders) {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = '';
            
            let ordersToDisplay = [];

            // ‘∂’ø’∏÷Ç’¥ ’•’∂÷Ñ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’®
            for (const key in allOrders) {
                const order = allOrders[key];
                
                // ’ë’∏÷Ç÷Å’°’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’¥’´’°’µ’∂ ’π÷É’°’Ø’æ’°’Æ (’π’¥’°’ø’∏÷Ç÷Å’æ’°’Æ) ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’®
                if (!order.status_kitchen_closed) {
                     // ‘≤’°÷Å’°’º’∏÷Ç’¥ ’•’∂÷Ñ ’Æ’°’º’°’µ’∏’≤’°’Ø’°’∂ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’® (‘ø’°’∂’π, ’Ä’°’∑’´’æ, ’Ä’°÷Ä÷Å’∂’∏÷Ç’¥)
                    if (!isServiceRequest(order)) {
                        ordersToDisplay.push({ key, order });
                    }
                }
            }

            // ‘¥’°’Ω’°’æ’∏÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’®’Ω’ø ’∞’∂’∏÷Ç’©’µ’°’∂ (’°’¥’•’∂’°’∞’´’∂’®’ù ’æ’•÷Ä÷á’∏÷Ç’¥)
            ordersToDisplay.sort((a, b) => a.order.timestamp - b.order.timestamp);
            
            let activeOrderCount = 0;
            
            ordersToDisplay.forEach(({ key, order }) => {
                
                // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’©’• ’°÷Ä’§’µ’∏÷Ñ ’∫’°’ø÷Ä’°’Ω’ø ’ß, ’¢’°’µ÷Å ’§’•’º ’π’´ ÷É’°’Ø’æ’•’¨
                const isDone = order.status_kitchen_done;
                const cardClass = isDone ? 'order-card ready' : 'order-card new';
                const buttonText = isDone ? '‚úÖ ’ä’°’ø÷Ä’°’Ω’ø ’ß' : '’Ñ’°’ø’∏÷Ç÷Å’•’¨’∏÷Ç ‘∑ ‘Ω’∏’∞’°÷Ä’°÷Ä’®';
                const buttonColor = isDone ? '#28a745' : '#007bff';
                activeOrderCount++;

                const itemListHTML = order.items.map(item => `
                    <li class="item">
                        <span class="item-name">${item.name}</span>
                        <span class="item-qty">x${item.qty}</span>
                    </li>
                `).join('');
                
                const commentHTML = order.comment ? `<div class="comment">’Ü’∑’∏÷Ç’¥: ${order.comment}</div>` : '';
                const orderTime = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });


                // ’ä‘±’è’é‘µ’ê‘ª ’î‘±’ê’è
                container.innerHTML += `
                    <div class="${cardClass}" data-order-key="${key}">
                        <div>
                            <div class="table-header">
                                <div class="table-num">’ç’•’≤’°’∂ #${order.table}</div>
                                <div class="order-time">${orderTime}</div>
                            </div>
                            
                            <ul class="items-list">
                                ${itemListHTML}
                            </ul>

                            ${commentHTML}
                        </div>
                        
                        <button class="action-button btn-done" 
                                onclick="markOrderAsDone('${key}')"
                                style="background-color: ${buttonColor};">
                            ${buttonText}
                        </button>
                    </div>
                `;
                
                // ’ç’Ø’Ω’∏÷Ç’¥ ’•’∂÷Ñ ’™’°’¥’°’∂’°’Ø’°’π’°÷É’®
                startTimer(order.timestamp, key);
            });
            
            document.getElementById('kitchenStatus').innerText = `‘±’Ø’ø’´’æ ’ä’°’ø’æ’•÷Ä’∂’•÷Ä: ${activeOrderCount}`;

            if (activeOrderCount === 0) {
                 container.innerHTML = '<p style="text-align: center; font-size: 1.2em; color:#777;">‘±’µ’Ω ’∫’°’∞’´’∂ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä ’π’Ø’°’∂÷â</p>';
            }
        }

        // ---------------------------------------------------
        //  ‘∫‘±’Ñ‘±’Ü‘±‘ø‘±’â‘±’ì‘ª ‘º’à‘≥‘ª‘ø‘±
        // ---------------------------------------------------

        function startTimer(startTime, orderKey) {
            const card = document.querySelector(`.order-card[data-order-key="${orderKey}"]`);
            if (!card) return; 

            // ‘±’æ’•’¨’°÷Å’∂’∏÷Ç’¥ ’•’∂÷Ñ ’™’°’¥’°’∂’°’Ø’°’π’°÷É’´ ’ø’∏’≤’®
            const timerDiv = document.createElement('div');
            timerDiv.className = 'timer';
            timerDiv.id = `timer-${orderKey}`;
            card.querySelector('.table-header').appendChild(timerDiv); 

            // ’ç’Ø’Ω’∏÷Ç’¥ ’•’∂÷Ñ ’∞’°’∑’æ’°÷Ä’Ø’®
            const interval = setInterval(() => {
                const diff = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                
                timerDiv.innerText = `‘∫’°’¥: ${m}:${s}`;
                
                // ‘¥’°’§’°÷Ä’•÷Å’∂’∏÷Ç’¥ ’•’∂÷Ñ, ’•’©’• ’∫’°’ø’æ’•÷Ä’® ’∂’∑’æ’•’¨ ’ß ’∏÷Ä’∫’•’Ω ’∫’°’ø÷Ä’°’Ω’ø (’•’©’• ’π’´ ’°’∂’∞’•’ø’°÷Å’•’¨ ’§’•’º)
                if (card.classList.contains('ready')) {
                    clearInterval(interval);
                }
            }, 1000);
            
            // ’ä’°’∞’∏÷Ç’¥ ’•’∂÷Ñ interval-’®, ’∏÷Ä’∫’•’Ω’¶’´ ’∞’∂’°÷Ä’°’æ’∏÷Ä ’¨’´’∂’´ ’§’°’§’°÷Ä’•÷Å’∂’•’¨
            card.dataset.timerInterval = interval;
        }

        // ---------------------------------------------------
        //  ‘≥’à’ê‘æ’à’Ç’à’í‘π’Ö’à’í’Ü’Ü‘µ’ê (’ä‘±’è’é‘µ’ê‘∏ ’ä‘±’è’ê‘±’ç’è ‘∑)
        // ---------------------------------------------------

        function markOrderAsDone(key) {
            if (confirm("’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’°’µ’Ω ’∫’°’ø’æ’•÷Ä’® ’∫’°’ø÷Ä’°’Ω’ø ’ß ÷á ’Ø’°÷Ä’∏’≤ ’ß ’¥’°’ø’∏÷Ç÷Å’æ’•’¨÷â")) {
                const button = document.querySelector(`.order-card[data-order-key="${key}"] .action-button`);
                button.innerText = '‘π’°÷Ä’¥’°÷Å’æ’∏÷Ç’¥ ’ß...';
                button.disabled = true;

                // ‘π’°÷Ä’¥’°÷Å’∂’∏÷Ç’¥ ’•’∂÷Ñ Firebase-’®
                db.ref('orders/' + key).update({
                    status_kitchen_done: true,
                    kitchen_done_time: Date.now()
                })
                .then(() => {
                    alert(`’ä’°’ø’æ’•÷Ä’® #${key} ’∂’∑’æ’•÷Å ’∏÷Ä’∫’•’Ω ’ä‘±’è’ê‘±’ç’è÷â`);
                })
                .catch(error => {
                    alert('’ç’≠’°’¨ ’∫’°’ø’æ’•÷Ä’® ’©’°÷Ä’¥’°÷Å’∂’•’¨’´’Ω÷â');
                    console.error(error);
                });
            }
        }

    </script>
</body>
</html>