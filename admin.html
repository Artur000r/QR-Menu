<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel PRO</title>
    <style>
        /* --- ’à’É‘µ’ê --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        header { border-bottom: 3px solid #1a4d2e; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: #1a4d2e; font-size: 28px; margin: 0; }
        
        /* ‘¥’•÷Ä’°’µ’´’∂ ’Ø’¨’°’Ω’•÷Ä’® ’Ω’Ø’¶’¢’∏÷Ç’¥ ’©’°÷Ñ’∂’æ’°’Æ ’•’∂ */
        .role-cashier, .role-manager { display: none; } 

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .stat-value { font-size: 32px; font-weight: 700; color: #1a4d2e; margin-top: 5px; }
        .stat-label { font-size: 14px; color: #777; }
        
        .control-panel, .order-table-container, .feedback-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 30px; }
        
        .stop-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .stop-list-item:last-child { border-bottom: none; }
        .product-name { font-weight: 600; cursor: pointer; text-decoration: underline; color: #007bff; }
        .status-btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .status-btn.available { background-color: #d4edda; color: #155724; }
        .status-btn.sold-out { background-color: #f8d7da; color: #721c24; }
        
        /* CMS ‘ø’°’º’°’æ’°÷Ä’∏÷Ç’¥ */
        .add-controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; padding: 15px; border: 1px dashed #ccc; border-radius: 8px; }
        .add-controls input, .add-controls select, .control-panel button, .add-controls textarea { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box;}
        .control-panel button { cursor: pointer; }
        #btnAddNew { background-color: #f0ad4e; color: white; border: none; font-weight: bold; }

        /* Edit Modal Styles */
        .edit-controls { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 15px; margin-top: 20px;
        }
        .edit-controls input, .edit-controls select, .edit-controls textarea {
            padding: 10px; border-radius: 6px; border: 1px solid #ccc;
            font-size: 14px;
        }
        .edit-controls textarea { grid-column: 1 / 4; height: 70px; }
        .delete-btn { background: #dc3545; color: white; border: none; }
        .img-preview { max-width: 100%; max-height: 100px; object-fit: cover; border-radius: 8px; margin-top: 10px; }

        /* MODAL STYLES (General) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 5000; display: flex; 
            justify-content: center; align-items: center; 
        }
        .modal-overlay.open { display: flex; }
        .modal-content { 
            background: white; padding: 30px; border-radius: 12px; 
            width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;
            position: relative;
        }
        .close-modal { 
            position: absolute; top: 10px; right: 10px; font-size: 24px; 
            cursor: pointer; color: #888;
        }

        /* ‘±’§’¥’´’∂’´ ’°’≤’µ’∏÷Ç’Ω’°’Ø’´ ’∏’≥’•÷Ä */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background-color: #f8f8f8; }
        
        .hidden { display: none !important; }
        .main-content { transition: opacity 0.5s; }
        
        /* ‘ø÷Ä’´’ø’´’Ø’°’Ø’°’∂ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’´ ’∞’°’ø’∏÷Ç’Ø ’∏’≥ */
        .critical-requests-container {
             background: #fff3cd; 
             border: 1px solid #ffeeba; 
             padding: 20px; 
             border-radius: 12px; 
             margin-bottom: 30px;
             box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <h2>’Ñ’∏÷Ç’ø÷Ñ’´ ‘ø’∏’§</h2>
            <input type="password" id="loginCode" placeholder="‘≥’°’≤’ø’∂’´ ’Ø’∏’§" style="width: 80%; padding: 15px; font-size: 18px; border-radius: 8px; border: 1px solid #ccc; margin: 15px 0;" onkeyup="if(event.key === 'Enter') attemptLogin()">
            <button onclick="attemptLogin()" style="background: #1a4d2e; color: white; padding: 15px; width: 80%; border: none; border-radius: 8px; font-weight: bold;">’Ñ’∏÷Ç’ø÷Ñ</button>
            <p style="color: #dc3545; margin-top: 10px; font-size: 12px;">‘ø’°’Ω’Ω’°: 2024 / ’Ñ’•’∂’•’ª’•÷Ä: 9999</p>
        </div>
    </div>

    <div id="mainContent" class="main-content hidden">
        <header>
            <h1>üìä ‘±’§’¥’´’∂ ’ä’°’∂’•’¨</h1>
            <div style="display:flex; align-items:center; gap: 10px;">
                <span id="currentUserRole" style="font-weight: bold; color: #007bff;"></span>
                <button onclick="fetchData()" style="padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">üîÉ ‘π’°÷Ä’¥’°÷Å’∂’•’¨</button>
            </div>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-label">‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’á÷Ä’ª’°’∂’°’º’∏÷Ç’©’µ’∏÷Ç’∂</div><div class="stat-value" id="totalSales">0 ÷è</div></div>
            <div class="stat-card"><div class="stat-label">‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä ’ä’°’ø’æ’•÷Ä’∂’•÷Ä</div><div class="stat-value" id="totalCount">0</div></div>
            <div class="stat-card"><div class="stat-label">’Ñ’´’ª’´’∂ ’â’•’Ø</div><div class="stat-value" id="avgCheck">0 ÷è</div></div>
            
            <div class="stat-card"><div class="stat-label">‘ø’°’∂’≠’´’Ø ’á÷Ä’ª’°’∂’°’º’∏÷Ç’©’µ’∏÷Ç’∂</div><div class="stat-value" id="cashSales">0 ÷è</div></div>
            <div class="stat-card"><div class="stat-label">‘±’∂’Ø’°’∂’≠’´’Ø ’á÷Ä’ª’°’∂’°’º’∏÷Ç’©’µ’∏÷Ç’∂</div><div class="stat-value" id="cardSales">0 ÷è</div></div>

            <div class="stat-card role-manager" id="avgRatingCard"><div class="stat-label">’Ñ’´’ª’´’∂ ‘≥’∂’°’∞’°’ø’°’Ø’°’∂</div><div class="stat-value avg-rating" id="avgRating">0.0</div></div>
        </div>
        
        <div class="control-panel role-manager">
            <h2>‚ûï ’Ñ’•’∂’µ’∏÷Ç’´ ‘ø’°’º’°’æ’°÷Ä’∏÷Ç’¥ (CMS)</h2>
            
            <div style="margin-bottom: 15px;">
                <button onclick="openCategoryModal()" style="background: #28a745; color: white; border: none;">‘ø’°’º’°’æ’°÷Ä’•’¨ ‘ø’°’ø’•’£’∏÷Ä’´’°’∂’•÷Ä’®</button>
                <button onclick="resetAllOrdersAndSessions()" style="background: #dc3545; color: white; border: none; margin-left: 10px;">‚ùå ’Ñ’°÷Ñ÷Ä’•’¨ ‘≤’∏’¨’∏÷Ä ’ä’°’ø’æ’•÷Ä’∂’•÷Ä’® (RESET)</button>
            </div>

            <div class="add-controls">
                <input type="text" id="inputName_hy" placeholder="‘±’∂’∏÷Ç’∂ (’Ä‘±’Ö)">
                <input type="text" id="inputName_en" placeholder="‘±’∂’∏÷Ç’∂ (ENG)">
                <input type="text" id="inputName_ru" placeholder="‘±’∂’∏÷Ç’∂ (RUS)">
                
                <input type="number" id="inputPrice" placeholder="‘≥’´’∂">
                <select id="inputCategory">
                    <option value="">‘∏’∂’ø÷Ä’•’¨ ‘ø’°’ø’•’£’∏÷Ä’´’°’∂</option>
                </select>
                <input type="url" id="inputImg" placeholder="’Ü’Ø’°÷Ä’´ ’∞’≤’∏÷Ç’¥ (URL)">
                
                <textarea id="inputDesc_hy" placeholder="‘≤’°’≤’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (’Ä’°’µ’•÷Ä’•’∂).." style="grid-column: 1 / 2; height: 60px;"></textarea> 
                <textarea id="inputDesc_en" placeholder="‘≤’°’≤’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (English).." style="grid-column: 2 / 3; height: 60px;"></textarea> 
                
                <button id="btnAddNew" onclick="addNewProduct()" style="grid-column: 3 / 4; height: 60px;">‘±’æ’•’¨’°÷Å’∂’•’¨ ’Ü’∏÷Ä ‘±’∫÷Ä’°’∂÷Ñ</button>
                
                <textarea id="inputDesc_ru" placeholder="‘≤’°’≤’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (–†—É—Å—Å–∫–∏–π).." style="grid-column: 1 / 4; height: 60px;"></textarea>
            </div>
        </div>

        <div class="control-panel role-manager">
            <h2>üõë Stop List ÷á ‘Ω’¥’¢’°’£÷Ä’∏÷Ç’¥</h2>
            <div id="stopListControls">
                </div>
        </div>
        
        <div class="control-panel role-cashier">
            <h2>üîë ‘±’Ø’ø’´’æ ’ç’•’≤’°’∂’∂’•÷Ä (’ç’•’°’∂’Ω’´ ’ì’°’Ø’∏÷Ç’¥)</h2>
            <div id="activeTablesContainer">
                <p style="color:#888;">‘±’Ø’ø’´’æ ’Ω’•’≤’°’∂’∂’•÷Ä ’π’Ø’°’∂÷â</p>
            </div>
        </div>
        
        <div class="critical-requests-container role-cashier">
            <h2>üîî ‘ø÷Ä’´’ø’´’Ø’°’Ø’°’∂ ’Ä’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä (‘ø’°’∂’π/’Ä’°’∑’´’æ)</h2>
            <div id="criticalRequestsList">
                <p style="color:#856404;">‘±’µ’Ω’ø’•’≤ ’Ø’•÷Ä÷á’°’∂ ’°’Ø’ø’´’æ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®:</p>
            </div>
            <button onclick="clearCriticalRequests()" style="margin-top: 15px; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 6px;">’Ñ’°÷Ñ÷Ä’•’¨ ‘≤’∏’¨’∏÷Ä ’Ä’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®</button>
        </div>
        
        <div class="control-panel role-cashier" style="background:#e8f5e9; border: 1px solid #c8e6c9;">
            <h2>‚úÖ ’ä’°’ø÷Ä’°’Ω’ø ’ß ’Ñ’°’ø’∏÷Ç÷Å’¥’°’∂</h2>
            <div id="readyOrdersList">
                <p style="color:#1a4d2e;">‘±’µ’Ω ’∫’°’∞’´’∂ ’∫’°’ø÷Ä’°’Ω’ø ’∏÷Ç’ø’•’Ω’ø’∂’•÷Ä ’π’Ø’°’∂:</p>
            </div>
        </div>


        <div class="feedback-container role-manager">
            <h2>‚≠ê ’Ä’°’≥’°’≠’∏÷Ä’§’∂’•÷Ä’´ ‘ø’°÷Ä’Æ’´÷Ñ’®</h2>
            <div id="feedbackList">
                </div>
        </div>

        <div class="order-table-container role-cashier">
            <h2>’ä’°’ø’æ’•÷Ä’∂’•÷Ä’´ ’Ä’°’∑’æ’°’º’∏÷Ç’¥ ÷á ’é’≥’°÷Ä’∏÷Ç’¥’∂’•÷Ä</h2>
            
            <div class="filter-controls" style="display:flex; gap: 20px; align-items:center;">
                
                <label for="filterType">’ñ’´’¨’ø÷Ä’¥’°’∂ ’ø’•’Ω’°’Ø:</label>
                <select id="filterType" onchange="toggleFilterInput()">
                    <option value="today">‘±’µ’Ω÷Ö÷Ä’æ’°</option>
                    <option value="date">‘∏’Ω’ø ‘±’¥’Ω’°’©’æ’´</option>
                    <option value="all">‘≤’∏’¨’∏÷Ä’® (’ä’°’ø’¥’∏÷Ç’©’µ’∏÷Ç’∂)</option>
                </select>

                <div id="dateFilterInput">
                    <label for="filterDate">‘±’¥’Ω’°’©’´’æ:</label>
                    <input type="date" id="filterDate" onchange="filterAndRender()">
                </div>
            </div>

            <h3 style="margin-top: 25px; color:#1a4d2e;">‘≤’°÷Å ’ä’°’ø’æ’•÷Ä’∂’•÷Ä (’â’æ’≥’°÷Ä’æ’°’Æ / ’â÷É’°’Ø’æ’°’Æ)</h3>
            <table id="openOrdersTable">
                <thead>
                    <tr><th>’ç’•’≤’°’∂</th><th>‘∏’∂’§’∞’°’∂’∏÷Ç÷Ä</th><th>’é’≥’°÷Ä’∏÷Ç’¥</th><th>‘Ω’∏’∞’°’∂’∏÷Å’´ ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø</th><th>’é’≥’°÷Ä’¥’°’∂ ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø</th></tr>
                </thead>
                <tbody id="openOrdersTableBody"></tbody>
            </table>

            <h3 style="margin-top: 40px; color:#777;">’ì’°’Ø’æ’°’Æ ’ä’°’ø’æ’•÷Ä’∂’•÷Ä’´ ’ä’°’ø’¥’∏÷Ç’©’µ’∏÷Ç’∂</h3>
            <table id="closedOrdersTable">
                <thead>
                    <tr><th>‘∫’°’¥</th><th>’ç’•’≤’°’∂</th><th>‘≥’∏÷Ç’¥’°÷Ä</th><th>’é’≥’°÷Ä’∏÷Ç’¥</th><th>’é’≥’°÷Ä’æ’°’Æ</th></tr>
                </thead>
                <tbody id="closedOrdersTableBody"></tbody>
            </table>
        </div>

        <div id="editProductModal" class="modal-overlay hidden">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('editProductModal')">‚úï</span>
                <h3>‘Ω’¥’¢’°’£÷Ä’•’¨ ‘±’∫÷Ä’°’∂÷Ñ’®’ù <span id="editProductNameDisplay"></span></h3>
                
                <div class="edit-controls">
                    <input type="text" id="editName_hy" placeholder="‘±’∂’∏÷Ç’∂ (’Ä’°’µ’•÷Ä’•’∂)">
                    <input type="text" id="editName_en" placeholder="‘±’∂’∏÷Ç’∂ (English)">
                    <input type="text" id="editName_ru" placeholder="‘±’∂’∏÷Ç’∂ (–†—É—Å—Å–∫–∏–π)">
                    
                    <input type="number" id="editPrice" placeholder="‘≥’´’∂">
                    <select id="editCategory">
                        <option value="">‘∏’∂’ø÷Ä’•’¨ ‘ø’°’ø’•’£’∏÷Ä’´’°’∂</option>
                    </select>
                    <input type="url" id="editImg" placeholder="’Ü’Ø’°÷Ä’´ ’∞’≤’∏÷Ç’¥ (URL)">
                    
                    <img id="editImgPreview" class="img-preview" src="" style="grid-column: 1 / 4; width: 100px;">
                    
                    <textarea id="editDesc_hy" placeholder="‘≤’°’≤’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (’Ä’°’µ’•÷Ä’•’∂).." style="grid-column: 1 / 4;"></textarea>
                    <textarea id="editDesc_en" placeholder="‘≤’°’≤’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (English).." style="grid-column: 1 / 4;"></textarea>
                    <textarea id="editDesc_ru" placeholder="‘≤’°’≤’°’§÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ (–†—É—Å—Å–∫–∏–π).." style="grid-column: 1 / 4;"></textarea>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button class="delete-btn" onclick="deleteProduct()">üóëÔ∏è ’ã’∂’ª’•’¨ ‘±’∫÷Ä’°’∂÷Ñ’®</button>
                    <button style="background: #1a4d2e; color: white;" onclick="saveProductEdit()">üíæ ’ä’°’∞’∫’°’∂’•’¨ ’ì’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’®</button>
                </div>
            </div>
        </div>

        <div id="categoryModal" class="modal-overlay hidden">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('categoryModal')">‚úï</span>
                <h3>‘ø’°’ø’•’£’∏÷Ä’´’°’∂’•÷Ä’´ ‘ø’°’º’°’æ’°÷Ä’∏÷Ç’¥</h3>
                
                <div id="categoryListContainer"></div>
                
                <div style="margin-top: 20px;">
                    <input type="text" id="newCatName" placeholder="’Ü’∏÷Ä ‘ø’°’ø’•’£’∏÷Ä’´’° (÷Ö÷Ä.’ù ‘æ’∏’æ’°’¥’©’•÷Ä÷Ñ)">
                    <input type="text" id="newCatId" placeholder="ID (÷Ö÷Ä.’ù seafood, ’¥’´’°’µ’∂ ’¨’°’ø’´’∂’°’ø’°’º)">
                    <button onclick="addNewCategory()">‚ûï ‘±’æ’•’¨’°÷Å’∂’•’¨</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==========================================
        // ‘¥‘ª’ê ’î’à FIREBASE-‘ª ’è’é’Ö‘±‘º’Ü‘µ’ê‘∏ ‘±’Ö’ç’è‘µ’Ç
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBzKoNezvEjHAkz7oqR5ZT2oYIzgaKS9HA",
            authDomain: "dolmamenu.firebaseapp.com",
            projectId: "dolmamenu",
            storageBucket: "dolmamenu.firebasestorage.app",
            messagingSenderId: "79065105652",
            appId: "1:79065105652:web:58dc22269a56c6c4ca4aa1",
            measurementId: "G-QX4RMX94QC"
        };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let allOrders = {}; 
        let menuItems = {}; 
        let allFeedbacks = {};
        let categoriesMap = {};
        
        let currentEditingProductId = null; 
        let currentRole = null; 

        // ‘¥’•÷Ä’•÷Ä’´ ’¥’∏÷Ç’ø÷Ñ’´ ’Ø’∏’§’•÷Ä’®
        const ROLES = {
            '2024': 'cashier',
            '9999': 'manager'
        };

        // --- ‘ø’à‘¥‘ª ’ç‘ø‘ª‘∂‘≤ ---

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginModal').style.display = 'flex';
            
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('filterDate').value = today;
            
            setupCategoryListener();
            setupStopListListener();
            
            document.getElementById('editImg').addEventListener('input', (e) => {
                document.getElementById('editImgPreview').src = e.target.value;
            });
            
            // ‘æ‘±’Ü’à’í’ë’à’í’Ñ’Ü‘µ’ê‘ª ‘π’à’í’Ö‘º’è’é’à’í‘π’Ö‘±’Ü ’Ä‘±’ê’ë’à’í’Ñ
            if ('Notification' in window) {
                Notification.requestPermission();
            }
            
            // ‘º’ç’à’í’Ñ ‘µ’Ü’î ’ä‘±’è’ê‘±’ç’è ‘ø‘±’ê‘≥‘±’é‘ª’É‘±‘ø‘ª ’ì’à’ì’à‘Ω’à’í‘π’Ö’à’í’Ü’Ü‘µ’ê‘∏ 
             db.ref('orders').on('child_changed', (snapshot) => {
                const data = snapshot.val();
                if (data.status_kitchen_done && !data.status_kitchen_closed) {
                     // ‘æ’°’∂’∏÷Ç÷Å’∏÷Ç’¥ ’¥’´’°’µ’∂ Cashier-’´’∂, ’•÷Ä’¢ ‘Ω’∏’∞’°’∂’∏÷Å’® ’∫’°’ø÷Ä’°’Ω’ø ’ß ’∂’∑’∏÷Ç’¥ ’∏÷Ç’ø’•’Ω’ø’®
                     if (currentRole === 'cashier') {
                         playSound();
                         showNotification(`‚úÖ ’ç‘µ’Ç‘±’Ü #${data.table} -’´ ’ä‘±’è’é‘µ’ê‘∏ ’ä‘±’è’ê‘±’ç’è ‘∑!`, 'cashier');
                     }
                }
            });
            
            // ’ç’Ø’¶’¢’∂’°’Ø’°’∂ ÷Ü’´’¨’ø÷Ä’´ ’Ø’°÷Ä’£’°’æ’∏÷Ä’∏÷Ç’¥
            toggleFilterInput();
        });
        
        // --- ‘º’à‘≥‘ª’Ü‘ª ‘º’à‘≥‘ª‘ø‘± ---
        function attemptLogin() {
            const code = document.getElementById('loginCode').value.trim();
            const role = ROLES[code];

            if (role) {
                currentRole = role;
                document.getElementById('currentUserRole').innerText = `‘¥’•÷Ä: ${role.toUpperCase()}`;
                
                document.getElementById('loginModal').style.display = 'none'; 
                document.getElementById('mainContent').classList.remove('hidden'); 
                
                filterSections(role);
                fetchData(); 
                fetchActiveTables(); 
                
                if (role === 'cashier') {
                    listenForCriticalOrders(); 
                    listenForReadyOrders();    
                }
                
            } else {
                alert("’ç’≠’°’¨ ’Ø’∏’§÷â ‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ÷É’∏÷Ä’±’•’¨ ’∂’∏÷Ä’´÷Å:");
            }
        }
        
        // --- ‘≤‘±‘∫‘ª’Ü’Ü‘µ’ê‘ª ’ñ‘ª‘º’è’ê‘±’ë‘ª‘± ‘∏’ç’è ‘¥‘µ’ê‘ª ---
        function filterSections(role) {
            document.querySelectorAll('.role-cashier, .role-manager').forEach(el => {
                el.style.display = 'none';
            });

            document.querySelectorAll(`.role-${role}`).forEach(el => {
                el.style.display = (el.classList.contains('stat-card') || el.classList.contains('stats-grid') || el.classList.contains('critical-requests-container')) ? '' : 'block'; 
            });

            const avgRatingCard = document.getElementById('avgRatingCard');
            if (avgRatingCard) {
                if (role === 'cashier') {
                    avgRatingCard.style.display = 'none';
                } else if (role === 'manager') {
                    avgRatingCard.style.display = '';
                }
            }

            document.getElementById('editProductModal').classList.add('hidden');
            document.getElementById('categoryModal').classList.add('hidden');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
            document.getElementById(id).classList.add('hidden'); 
        }
        
        function fetchData() {
            fetchOrders(); 
            if(currentRole === 'manager') {
                 fetchFeedbacks();
            }
        }
        
        // --- ’Ä‘±’Ñ‘±‘ø‘±’ê‘≥‘ª ‘∂’ê’à’Ö‘±’ë’Ñ‘±’Ü ’ñ’à’í’Ü‘ø’ë‘ª‘± (RESET) ---
        function resetAllOrdersAndSessions() {
            if (currentRole !== 'manager') {
                alert("’Ñ’´’°’µ’∂ ’Ñ’•’∂’•’ª’•÷Ä’∂ ’ß ’´÷Ä’°’æ’°’Ω’∏÷Ç ’Ø’°’ø’°÷Ä’•’¨ ’°’µ’Ω ’£’∏÷Ä’Æ’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂’®÷â");
                return;
            }

            if (!confirm("‘∂‘≥’à’í’á‘±’ë’à’í’Ñ: ’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ÷Å’°’∂’Ø’°’∂’∏÷Ç’¥ ’•÷Ñ ’°’∂’æ’•÷Ä’°’§’°÷Ä’± ’ª’∂’ª’•’¨ ‘≤’à‘º’à’ê ’ä‘±’è’é‘µ’ê’Ü‘µ’ê‘∏, ’Ä‘±’ê’ë’à’í’Ñ’Ü‘µ’ê‘∏ ÷á ‘±‘ø’è‘ª’é ’ç‘µ‘±’Ü’ç’Ü‘µ’ê‘∏ (’°’µ’Ω’´’∂÷Ñ’∂’ù ’°’¥’¢’∏’≤’ª ’£’∏÷Ä’Æ’°÷Ä÷Ñ’°’µ’´’∂ ’∫’°’ø’¥’∏÷Ç’©’µ’∏÷Ç’∂’®)÷â ‘±’µ’Ω ’£’∏÷Ä’Æ’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂’® ’π’´ ’Ø’°÷Ä’∏’≤ ’π’•’≤’°÷Ä’Ø’æ’•’¨÷â")) {
                return;
            }
            
            // ‘≥’∏÷Ä’Æ’∏’≤’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’® ’Ø’°’ø’°÷Ä’æ’∏÷Ç’¥ ’•’∂ ’°’∂’Ø’°’≠
            const deleteOrders = db.ref('orders').remove();
            const deleteFeedback = db.ref('feedback').remove();
            const deleteSessions = db.ref('table_sessions').remove();

            Promise.all([deleteOrders, deleteFeedback, deleteSessions])
                .then(() => {
                    alert("‘≤’∏’¨’∏÷Ä ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’®, ’Ø’°÷Ä’Æ’´÷Ñ’∂’•÷Ä’® ÷á ’°’Ø’ø’´’æ ’Ω’•’°’∂’Ω’∂’•÷Ä’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’¥’°÷Ñ÷Ä’æ’•÷Å’´’∂÷â ’á÷Ä’ª’°’∂’°’º’∏÷Ç’©’µ’∏÷Ç’∂’® ’¶÷Ä’∏’µ’°÷Å’æ’°’Æ ’ß÷â");
                    location.reload(); 
                })
                .catch(error => {
                    alert("’ç’≠’°’¨ ’¥’°÷Ñ÷Ä’•’¨’´’Ω: " + error.message);
                    console.error("Reset Error:", error);
                });
        }
        
        // --- ‘ø‘±’è‘µ‘≥’à’ê‘ª‘±’Ü‘µ’ê‘ª ‘ø‘±’å‘±’é‘±’ê’à’í’Ñ (’Ñ’•’∂’•’ª’•÷Ä) ---
        function setupCategoryListener() {
            db.ref('categories').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                categoriesMap = {};
                if (data) {
                    for(let id in data) { categoriesMap[id] = data[id].hy; }
                } 
                renderCategorySelect(); 
                renderEditCategorySelect(); 
            });
        }
        function renderCategorySelect() {
            const select = document.getElementById('inputCategory');
            select.innerHTML = '<option value="">‘∏’∂’ø÷Ä’•’¨ ‘ø’°’ø’•’£’∏÷Ä’´’°’∂</option>';
            for(let id in categoriesMap) { select.innerHTML += `<option value="${id}">${categoriesMap[id]}</option>`; }
        }
        function renderEditCategorySelect(selectedCatId = '') {
            const select = document.getElementById('editCategory');
            select.innerHTML = '<option value="">‘∏’∂’ø÷Ä’•’¨ ‘ø’°’ø’•’£’∏÷Ä’´’°’∂</option>';
            for(let id in categoriesMap) {
                const isSelected = id === selectedCatId ? 'selected' : '';
                select.innerHTML += `<option value="${id}" ${isSelected}>${categoriesMap[id]}</option>`;
            }
        }
        function openCategoryModal() {
            const modal = document.getElementById('categoryModal');
            modal.classList.add('open');
            modal.classList.remove('hidden');
            renderCategoryList();
        }
        function renderCategoryList() {
            const container = document.getElementById('categoryListContainer');
            container.innerHTML = '';
            for (let id in categoriesMap) {
                container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding: 8px 0;">
                        <span style="font-weight: bold;">${categoriesMap[id]}</span> (ID: ${id})
                        <button class="remove-option-btn" onclick="removeCategory('${id}')">’ã’∂’ª’•’¨</button>
                    </div>`;
            }
        }
        function addNewCategory() {
            const name = document.getElementById('newCatName').value.trim();
            const id = document.getElementById('newCatId').value.trim().toLowerCase();
            if (!name || !id) { alert("‘º÷Ä’°÷Å÷Ä’•÷Ñ ’°’∂’∏÷Ç’∂’® ÷á ID-’∂÷â"); return; }
            if (categoriesMap[id]) { alert("‘±’µ’Ω ID-’∂ ’°÷Ä’§’•’∂ ’£’∏’µ’∏÷Ç’©’µ’∏÷Ç’∂ ’∏÷Ç’∂’´÷â"); return; }
            db.ref('categories/' + id).set({ hy: name }).then(() => { alert(`‘ø’°’ø’•’£’∏÷Ä’´’° "${name}"-’® ’°’æ’•’¨’°÷Å’æ’•÷Å÷â`); document.getElementById('newCatName').value = ''; document.getElementById('newCatId').value = ''; });
        }
        function removeCategory(id) {
            if (confirm(`’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’∏÷Ç’¶’∏÷Ç’¥ ’•÷Ñ ’ª’∂’ª’•’¨ ${categoriesMap[id]}-’®÷â`)) {
                 db.ref('categories/' + id).remove().then(() => alert('’ã’∂’ª’æ’°’Æ ’ß÷â'));
            }
        }
        
        // ---------------------------------------------------
        //  CMS & CRUD ’ñ’à’í’Ü‘ø’ë‘ª‘±’Ü‘µ’ê (’Ñ’•’∂’•’ª’•÷Ä)
        // ---------------------------------------------------

        function addNewProduct() {
            const name_hy = document.getElementById('inputName_hy').value.trim();
            const name_en = document.getElementById('inputName_en').value.trim();
            const name_ru = document.getElementById('inputName_ru').value.trim();
            
            const price = parseFloat(document.getElementById('inputPrice').value);
            const category = document.getElementById('inputCategory').value;
            const imgUrl = document.getElementById('inputImg').value.trim(); 
            
            const desc_hy = document.getElementById('inputDesc_hy').value.trim();
            const desc_en = document.getElementById('inputDesc_en').value.trim();
            const desc_ru = document.getElementById('inputDesc_ru').value.trim();

            if (!name_hy || isNaN(price) || price <= 0 || !category || !imgUrl) {
                alert("‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’¨÷Ä’°÷Å’∂’•’¨ ’∞’°’µ’•÷Ä’•’∂ ’°’∂’∏÷Ç’∂’®, ’£’´’∂’®, ’Ø’°’ø’•’£’∏÷Ä’´’°’∂ ÷á ’∂’Ø’°÷Ä’´ ’∞’≤’∏÷Ç’¥’®:");
                return;
            }

            const btn = document.getElementById('btnAddNew');
            btn.innerText = '‘±’æ’•’¨’°÷Å’æ’∏÷Ç’¥ ’ß...';
            btn.disabled = true;

            const newProductData = {
                category: category,
                imgUrl: imgUrl, 
                name: { hy: name_hy, en: name_en || name_hy, ru: name_ru || name_hy }, 
                desc: { hy: desc_hy, en: desc_en || ' ', ru: desc_ru || ' ' },
                price: price
            };
            
            db.ref('menu_items').push(newProductData)
            .then(() => {
                alert(`¬´${name_hy}¬ª-’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’°’æ’•’¨’°÷Å’æ’•÷Å:`);
                document.querySelectorAll('.add-controls input[type="text"], .add-controls input[type="url"], .add-controls input[type="number"], .add-controls textarea').forEach(el => el.value = '');
                document.getElementById('inputCategory').value = '';
            })
            .catch(error => {
                console.error("Error in addNewProduct:", error);
                alert("’ç’≠’°’¨÷â ‘±’∫÷Ä’°’∂÷Ñ’® ’π’°’æ’•’¨’°÷Å’æ’•÷Å÷â");
            })
            .finally(() => {
                 btn.innerText = '‘±’æ’•’¨’°÷Å’∂’•’¨ ’Ü’∏÷Ä ‘±’∫÷Ä’°’∂÷Ñ';
                 btn.disabled = false;
            });
        }

        function openEditModal(productId) {
            currentEditingProductId = productId;
            const product = menuItems[productId];

            if (!product) return alert("‘±’∫÷Ä’°’∂÷Ñ’® ’π’£’ø’∂’æ’•÷Å:");

            document.getElementById('editProductNameDisplay').innerText = product.name.hy;
            
            document.getElementById('editName_hy').value = product.name.hy || '';
            document.getElementById('editName_en').value = product.name.en || '';
            document.getElementById('editName_ru').value = product.name.ru || '';
            
            document.getElementById('editPrice').value = product.price || '';
            const imgUrl = product.imgUrl || '';
            document.getElementById('editImg').value = imgUrl; 
            document.getElementById('editImgPreview').src = imgUrl; 
            
            document.getElementById('editDesc_hy').value = product.desc ? product.desc.hy : '';
            document.getElementById('editDesc_en').value = product.desc ? product.desc.en : '';
            document.getElementById('editDesc_ru').value = product.desc ? product.desc.ru : '';


            renderEditCategorySelect(product.category);

            const modal = document.getElementById('editProductModal');
            modal.classList.add('open');
            modal.classList.remove('hidden');
        }

        function saveProductEdit() {
            const id = currentEditingProductId;
            if (!id) return;

            const name_hy = document.getElementById('editName_hy').value.trim();
            const name_en = document.getElementById('editName_en').value.trim();
            const name_ru = document.getElementById('editName_ru').value.trim();
            
            const price = parseFloat(document.getElementById('editPrice').value);
            const category = document.getElementById('editCategory').value;
            const imgUrl = document.getElementById('editImg').value.trim();
            
            const desc_hy = document.getElementById('editDesc_hy').value.trim();
            const desc_en = document.getElementById('editDesc_en').value.trim();
            const desc_ru = document.getElementById('editDesc_ru').value.trim();


            if (!name_hy || isNaN(price) || price <= 0 || !category || !imgUrl) {
                alert("‘Ω’∂’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’¨÷Ä’°÷Å’∂’•’¨ ’∞’°’µ’•÷Ä’•’∂ ’°’∂’∏÷Ç’∂’®, ’£’´’∂’®, ’Ø’°’ø’•’£’∏÷Ä’´’°’∂ ÷á ’∂’Ø’°÷Ä’´ ’∞’≤’∏÷Ç’¥’®:");
                return;
            }
            
            const saveBtn = document.querySelector('#editProductModal button[onclick="saveProductEdit()"]');
            saveBtn.innerText = '’ä’°’∞’∫’°’∂’æ’∏÷Ç’¥ ’ß...';
            saveBtn.disabled = true;

            const updatedData = {
                category: category,
                imgUrl: imgUrl, 
                name: { hy: name_hy, en: name_en || name_hy, ru: name_ru || name_hy },
                desc: { hy: desc_hy || ' ', en: desc_en || ' ', ru: desc_ru || ' ' },
                price: price
            };

            db.ref('menu_items/' + id).update(updatedData)
            .then(() => {
                alert(`¬´${name_hy}¬ª-’´ ÷É’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’® ’∫’°’∞’∫’°’∂’æ’•÷Å’´’∂÷â`);
                closeModal('editProductModal');
            })
            .catch(error => {
                alert("’ç’≠’°’¨÷â ’ì’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’® ’π’∫’°’∞’∫’°’∂’æ’•÷Å’´’∂÷â " + error.message);
                console.error("Update Error:", error);
            })
            .finally(() => {
                saveBtn.innerText = 'üíæ ’ä’°’∞’∫’°’∂’•’¨ ’ì’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’®';
                saveBtn.disabled = false;
            });
        }
        
        function deleteProduct() {
            const id = currentEditingProductId;
            const name = menuItems[id] ? menuItems[id].name.hy : '’°’µ’Ω ’°’∫÷Ä’°’∂÷Ñ’®';

            if (confirm(`’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’∏÷Ç’¶’∏÷Ç’¥ ’•÷Ñ ’°’∂’æ’•÷Ä’°’§’°÷Ä’± ’ª’∂’ª’•’¨ ${name}-’® ’¥’•’∂’µ’∏÷Ç’´÷Å÷â`)) {
                db.ref('menu_items/' + id).remove()
                .then(() => {
                    db.ref('stop_status/' + id).remove();
                    alert(`${name}-’® ’∞’°’ª’∏’≤’∏÷Ç’©’µ’°’¥’¢ ’ª’∂’ª’æ’•÷Å÷â`);
                    closeModal('editProductModal');
                })
                .catch(error => {
                    alert("’ç’≠’°’¨÷â ‘±’∫÷Ä’°’∂÷Ñ’® ’π’ª’∂’ª’æ’•÷Å÷â");
                    console.error("Delete Error:", error);
                });
            }
        }

        // --- ’ç’è’à’ä ‘º‘ª’ç’è‘ª ‘ø‘±’å‘±’é‘±’ê’à’í’Ñ (’Ñ’•’∂’•’ª’•÷Ä) ---
        function setupStopListListener() {
            db.ref('menu_items').on('value', (snapshot) => {
                menuItems = snapshot.val() || {};
                db.ref('stop_status').on('value', (stopSnapshot) => {
                    const statusData = stopSnapshot.val() || {};
                    renderStopList(statusData);
                });
            });
        }
        function renderStopList(statusData) {
            const container = document.getElementById('stopListControls');
            container.innerHTML = '';
            for (const pId in menuItems) {
                const p = menuItems[pId];
                const isSoldOut = statusData[pId] ? statusData[pId].soldOut : false;
                const btnClass = isSoldOut ? 'sold-out' : 'available';
                const btnText = isSoldOut ? '‘±’æ’°÷Ä’ø’æ’°’Æ ’ß üõë' : '‘±’º’Ø’° ’ß ‚úÖ';
                
                container.innerHTML += `
                    <div class="stop-list-item">
                        <span class="product-name" onclick="openEditModal('${pId}')">
                            ${p.name.hy} (${categoriesMap[p.category] || '‘±’∂’Ø’°’ø’•’£’∏÷Ä’´’°'})
                        </span>
                        <div style="display:flex; gap: 10px;">
                            <button onclick="openEditModal('${pId}')" style="background:#007bff; color:white; padding: 5px 10px;">‚öôÔ∏è ‘Ω’¥’¢’°’£÷Ä’•’¨</button>
                            <button class="status-btn ${btnClass}" onclick="toggleStatus('${pId}', ${isSoldOut})">
                                ${btnText}
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        function toggleStatus(id, isCurrentlySoldOut) {
            const newStatus = !isCurrentlySoldOut;
            const btn = document.querySelector(`.stop-list-item button[onclick*="${id}"]`);

            if (btn) {
                btn.innerText = '‘π’°÷Ä’¥’°÷Å’æ’∏÷Ç’¥ ’ß...';
                btn.disabled = true;
            }
            
            db.ref('stop_status/' + id).set({
                soldOut: newStatus
            }).catch(error => { 
                alert("’ç’≠’°’¨÷â ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø’® ’π÷É’∏’≠’æ’•÷Å÷â"); 
            });
        }
        
        // --- ‘±‘ø’è‘ª’é ’ç‘µ’Ç‘±’Ü’Ü‘µ’ê‘ª ‘ø‘±’å‘±’é‘±’ê’à’í’Ñ (‘ø’°’Ω’Ω’°) ---
        function fetchActiveTables() {
            db.ref('table_sessions').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                if(currentRole === 'cashier') {
                    renderActiveTables(data);
                }
            });
        }

        function renderActiveTables(sessions) {
            const container = document.getElementById('activeTablesContainer');
            container.innerHTML = '';
            let hasActiveTables = false;

            for (const tNum in sessions) {
                const session = sessions[tNum];
                if (session.is_occupied) {
                    hasActiveTables = true;
                    const startTime = new Date(session.start_time).toLocaleTimeString();
                    
                    // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ’ù ’°÷Ä’§’µ’∏÷Ñ ’Ø’° ’Ω’∫’°’Ω’∏’≤ ’∞’°÷Ä÷Å’∏÷Ç’¥
                    const request = session.pending_request;
                    let requestBadge = '';
                    let requestActionBtn = '';
                    let badgeColor = '';
                    
                    if (request) {
                        // ‘ø’°’≠’æ’°’Æ ’∞’°÷Ä÷Å’∏÷Ç’¥’´÷Å, ’£’∏÷Ç’µ’∂ ’•’∂÷Ñ ’ø’°’¨’´’Ω
                        if (request === '’Ä’°’∑’´’æ') {
                            badgeColor = '#dc3545'; // ‘ø’°÷Ä’¥’´÷Ä ’∞’°’∑’æ’´ ’∞’°’¥’°÷Ä
                            requestBadge = `<span style="background:${badgeColor}; color:white; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; margin-left: 10px;">üßæ ’Ä‘±’á‘ª’é!</span>`;
                        } else if (request === '‘ø’°’∂’π') {
                            badgeColor = '#ffc107'; // ‘¥’•’≤’´’∂ ’Ø’°’∂’π’´ ’∞’°’¥’°÷Ä
                            requestBadge = `<span style="background:${badgeColor}; color:#333; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; margin-left: 10px;">üîî ‘ø‘±’Ü’â!</span>`;
                        }
                        
                        // ‘ø’∏’≥’°’Ø’®’ù ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’¥’°÷Ñ÷Ä’•’¨’∏÷Ç ’∞’°’¥’°÷Ä
                        requestActionBtn = `<button onclick="clearTableRequest('${tNum}')" 
                                                style="background: #1a4d2e; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                                                ’Ñ’°÷Ñ÷Ä’•’¨ ${request}
                                            </button>`;
                    }

                    container.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px dashed #eee;">
                            <div style="display:flex; align-items:center;">
                                <span style="font-size: 18px; font-weight: bold;">’ç’•’≤’°’∂ #${tNum}</span>
                                ${requestBadge} 
                            </div>
                            <div style="display:flex; align-items:center;">
                                <span style="color: #777; margin-right: 15px;">(’ç’Ø’´’¶’¢: ${startTime})</span>
                                ${requestActionBtn}
                                
                                <button onclick="confirmPaymentForTable(${tNum})" 
                                        style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                                    üíµ ’Ä’°’Ω’ø’°’ø’•’¨ ’é’≥’°÷Ä’∏÷Ç’¥’®
                                </button>
                                
                                <button onclick="closeTableFromAdmin('${tNum}')" 
                                        style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                                    ’ì’°’Ø’•’¨ ’ç’•’≤’°’∂’®
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (!hasActiveTables) {
                 container.innerHTML = '<p style="color:#888;">‘±’Ø’ø’´’æ ’Ω’•’≤’°’∂’∂’•÷Ä ’π’Ø’°’∂÷â</p>';
            }
        }
        
        function closeTableFromAdmin(tableNum) {
            if(!confirm(`’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’ç’•’≤’°’∂ ${tableNum}-’® ’¥’°÷Ñ÷Ä’æ’•’¨ ’ß ÷á ’Ø’°÷Ä’∏’≤ ’ß ’°’¶’°’ø’æ’•’¨ ’∂’∏÷Ä ’∞’°’≥’°’≠’∏÷Ä’§’´ ’∞’°’¥’°÷Ä÷â`)) {
                return;
            }
            
            db.ref('orders').once('value').then(snapshot => {
                const orders = snapshot.val() || {};
                const updates = {};
                
                for (const key in orders) {
                    const order = orders[key];
                    if (order.table == tableNum && !order.status_kitchen_closed) {
                        // ’ì’°’Ø’∏÷Ç’¥ ’•’∂÷Ñ ’∂’°÷á ’π÷É’°’Ø’æ’°’Æ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® ’Ω’•’≤’°’∂’´ ÷É’°’Ø’¥’°’∂ ’™’°’¥’°’∂’°’Ø
                        updates[`/orders/${key}/status_kitchen_closed`] = true;
                    }
                }
                
                updates[`/table_sessions/${tableNum}`] = null; 
                
                db.ref().update(updates)
                .then(() => {
                    alert(`’ç’•’≤’°’∂ ${tableNum}-’´ ’Ω’•’°’∂’Ω’® ÷É’°’Ø’æ’•÷Å, ÷á ’°’µ’∂ ’°’¶’°’ø ’ß÷â`);
                    fetchData(); 
                })
                .catch(error => {
                    alert("’ç’≠’°’¨ ’Ω’•’°’∂’Ω’® ÷É’°’Ø’•’¨’´’Ω: " + error.message);
                });
            });
        }
        
        function clearTableRequest(tableNum) {
             if (confirm(`’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’ç’•’≤’°’∂ ${tableNum}-’´ ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’Ø’°’ø’°÷Ä’æ’°’Æ ’ß÷â`)) {
                 db.ref('table_sessions/' + tableNum).update({
                     pending_request: null,
                     request_time: null
                 })
                 .then(() => {
                     alert(`’ç’•’≤’°’∂ ${tableNum}-’´ ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’¥’°÷Ñ÷Ä’æ’•÷Å÷â`);
                 })
                 .catch(error => {
                     alert("’ç’≠’°’¨ ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’¥’°÷Ñ÷Ä’•’¨’´’Ω: " + error.message);
                 });
             }
        }
        
        // --- ‘ø‘±’ê‘æ‘ª’î’Ü‘µ’ê ‘µ’é ’é‘ª’É‘±‘ø‘±‘≥’ê’à’í‘π’Ö’à’í’Ü ---
        function fetchFeedbacks() {
             db.ref('feedback').once('value').then(snapshot => {
                allFeedbacks = snapshot.val() || {};
                renderFeedbacks();
            }).catch(error => { console.error("Feedback Error:", error); });
        }
        function renderFeedbacks() {
            const container = document.getElementById('feedbackList');
            container.innerHTML = '';
            let totalRating = 0; let count = 0;
            const feedbackArray = [];
            for(let key in allFeedbacks) { feedbackArray.push(allFeedbacks[key]); }
            feedbackArray.sort((a, b) => b.timestamp - a.timestamp);
            feedbackArray.forEach(f => {
                totalRating += f.rating; count++;
                const date = new Date(f.timestamp).toLocaleDateString();
                const time = new Date(f.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const stars = '‚òÖ'.repeat(f.rating) + '‚òÜ'.repeat(5 - f.rating);
                container.innerHTML += `<div class="feedback-item"><div class="feedback-info"><div class="rating-stars">${stars}</div><div>’ç’•’≤’°’∂ ${f.table}</div><small>${date} ${time}</small></div><div class="feedback-text">${f.comment || '_(‘±’º’°’∂÷Å ’¥’•’Ø’∂’°’¢’°’∂’∏÷Ç’©’µ’°’∂)_'}</div></div>`;
            });
            const avg = count > 0 ? (totalRating / count).toFixed(1) : '0.0';
            document.getElementById('avgRating').innerText = avg;
        }
        
        // --- ’ä‘±’è’é‘µ’ê’Ü‘µ’ê‘ª ‘≤‘µ’å’Ü’à’í’Ñ (‘ª’ê‘±‘ø‘±’Ü ‘∫‘±’Ñ‘±’Ü‘±‘ø‘ª ‘π‘±’ê’Ñ‘±’ë’à’í’Ñ) ---
        function fetchOrders() {
            db.ref('orders').on('value', (snapshot) => {
                allOrders = {}; 
                snapshot.forEach(childSnapshot => {
                    const val = childSnapshot.val();
                    
                    // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ’ù ’°÷Ä’§’µ’∏÷Ñ ’∫’°’ø’æ’•÷Ä’® ’∫’°÷Ä’∏÷Ç’∂’°’Ø’∏÷Ç’¥ ’ß ’°’∫÷Ä’°’∂÷Ñ’∂’•÷Ä (’∏’π ’¥’´’°’µ’∂ service ’∞’°÷Ä÷Å’∏÷Ç’¥)
                    const isServiceRequest = val.items && val.items.length > 0 && (
                        val.items[0].name.includes("‘Ω’Ü‘¥’ê’à’í’Ñ ‘µ’Ü ’Ä‘±’á‘ª’é‘∏") || 
                        val.items[0].name.includes("‘ø‘±’Ü’â") || 
                        val.items[0].name.includes("’Ä‘±’ê’ë’Ü’à’í’Ñ")
                    );

                    // ‘ø‘±’ê‘µ’é’à’ê: ’Ü’•÷Ä’°’º’•’¨ ‘≤’à‘º’à’ê ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® (’°’µ’§ ’©’æ’∏÷Ç’¥’ù ’°’∫÷Ä’°’∂÷Ñ’°’µ’´’∂ ÷á service-’®),
                    // ’∏÷Ä’∫’•’Ω’¶’´ ÷Ü’´’¨’ø÷Ä’∏÷Ç’¥’® ’ø’•’≤’´ ’∏÷Ç’∂’•’∂’° filterAndRender-’´ ’∂’•÷Ä’Ω’∏÷Ç’¥:
                    // ’à’â‘ª’Ü’â ’â‘µ’Ü’î ’ñ‘ª‘º’è’ê’à’í’Ñ ‘±’Ö’ç ’ì’à’í‘º’à’í’Ñ:
                    if (val.items && val.items.length > 0) { 
                        allOrders[childSnapshot.key] = val; 
                    }
                });
                
                // ‘ø‘±’ê‘µ’é’à’ê: ‘π’°÷Ä’¥’°÷Å’∂’•’¨ ÷Å’∏÷Ç÷Å’°’§÷Ä’∏÷Ç’¥’® ’°’¥’•’∂ ’¢’•’º’∂’∏÷Ç’¥’´÷Å ’∞’•’ø’∏
                filterAndRender(); 
            });
        }
        
        // --- ’ñ‘ª‘º’è’ê‘ª ’è‘µ’ç‘±’Ü‘µ‘º‘ª’à’í‘π’Ö‘±’Ü ‘ø‘±’å‘±’é‘±’ê’à’í’Ñ ---
        function toggleFilterInput() {
            const filterType = document.getElementById('filterType').value;
            const dateInputDiv = document.getElementById('dateFilterInput');
            
            if (filterType === 'all') {
                dateInputDiv.style.display = 'none';
            } else if (filterType === 'today') {
                dateInputDiv.style.display = 'block';
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('filterDate').value = today;
            } else { // 'date'
                dateInputDiv.style.display = 'block';
            }
            filterAndRender(); 
        }

        // ’ï‘≥’Ü‘±‘ø‘±’Ü ’ñ’à’í’Ü‘ø’ë‘ª‘±’ù ‘±’Ñ’ç‘±‘π’é’à’é ’ñ‘ª‘º’è’ê‘µ‘º’à’í ’Ä‘±’Ñ‘±’ê
        function ordersByDate(allOrders, filterDateStr) {
             const result = {};
             for (const key in allOrders) {
                const order = allOrders[key];
                
                if (!order.timestamp) continue; // ‘±’∂’ø’•’Ω’•’¨, ’•’©’• ’π’Ø’° ’™’°’¥’°’∂’°’Ø
                
                const orderDate = new Date(order.timestamp).toISOString().slice(0, 10);
                if (orderDate === filterDateStr) {
                    result[key] = order;
                }
             }
             return result;
        }

        // --- ’ñ‘ª‘º’è’ê‘±’ë‘ª‘± ‘µ’é ’ë’à’í’ë‘±‘¥’ê’à’í’Ñ (’á’ê’ã‘±’Ü‘±’å’à’í‘π’Ö‘±’Ü ’É‘ª’á’è ’Ä‘±’á’é‘±’ê‘ø) ---
        function filterAndRender() {
            const filterType = document.getElementById('filterType').value;
            let ordersToProcess = allOrders; 

            // ‘ø‘±’ê‘µ’é’à’ê. ‘±’¥’Ω’°’©’æ’∏’æ ÷Ü’´’¨’ø÷Ä’∏÷Ç’¥
            if (filterType === 'today' || filterType === 'date') {
                // ordersByDate ÷Ü’∏÷Ç’∂’Ø÷Å’´’°’∂ ’°÷Ä’§’•’∂ ÷Ü’´’¨’ø÷Ä’∏÷Ç’¥ ’ß
                 ordersToProcess = ordersByDate(allOrders, document.getElementById('filterDate').value);
            } 
            // ‘µ’©’• filterType === 'all', ordersToProcess-’® ’¥’∂’∏÷Ç’¥ ’ß allOrders

            // --- ’á’ê’ã‘±’Ü‘±’å’à’í‘π’Ö‘±’Ü ’Ä‘±’á’é‘±’ê‘ø ---
            let totalSales = 0; 
            let totalCount = 0; 
            let cashSales = 0;   
            let cardSales = 0;   
            
            const ordersGroupedByTable = {};
            const closedOrders = [];
            const serviceRequests = [];


            for (const key in ordersToProcess) {
                const order = ordersToProcess[key];
                
                if (!order.items || order.items.length === 0) continue; 
                
                // ‘ø‘±’ê‘µ’é’à’ê. ‘≤’°÷Å’°’∞’°’µ’ø’•’¨ Service Requests-’®
                const isServiceRequest = order.items[0].name.includes("‘Ω’Ü‘¥’ê’à’í’Ñ ‘µ’Ü ’Ä‘±’á‘ª’é‘∏") || order.items[0].name.includes("‘ø‘±’Ü’â’à’í’Ñ ‘µ’Ü ’Ñ‘±’è’à’í’ë’à’Ç‘ª’Ü");

                if (isServiceRequest) {
                     // Service ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’® ’π’•’∂ ’¥’°’Ω’∂’°’Ø÷Å’∏÷Ç’¥ ’∑÷Ä’ª’°’∂’°’º’∏÷Ç’©’µ’°’∂’® ’Ø’°’¥ ’°’≤’µ’∏÷Ç’Ω’°’Ø’∂’•÷Ä’´’∂
                     serviceRequests.push(order); 
                     continue;
                }


                let orderTotal = order.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
                
                // ’é’´’≥’°’Ø’°’£÷Ä’∏÷Ç’©’µ’°’∂ ’∞’°’¥’°÷Ä ’∞’°’∑’æ’°÷Ä’Ø’∏÷Ç’¥ ’•’∂÷Ñ ’Ñ‘ª‘±’Ö’Ü ’∞’°’Ω’ø’°’ø’æ’°’Æ ’æ’≥’°÷Ä’∏÷Ç’¥’∂’•÷Ä’®
                const isConfirmedForStats = order.payment_confirmed; 
                
                if (isConfirmedForStats) {
                    totalSales += orderTotal; 
                    totalCount++; 
                    
                    if (order.payMethod === '‘ø’°’∂’≠’´’Ø') {
                        cashSales += orderTotal;
                    } else if (order.payMethod === '’î’°÷Ä’ø') {
                        cardSales += orderTotal;
                    }
                }
                
                // ‘≤‘±‘∫‘±’Ü’à’í’Ñ ‘µ’Ü’î ‘∏’ç’è ‘ø‘±’ê‘≥‘±’é‘ª’É‘±‘ø‘ª
                if (order.status_kitchen_closed) {
                    // ’ì’°’Ø’æ’°’Æ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® ’£’∂’∏÷Ç’¥ ’•’∂ ’∫’°’ø’¥’∏÷Ç’©’µ’∏÷Ç’∂ (’ç’ø’∏÷Ä’´’∂ ’°’≤’µ’∏÷Ç’Ω’°’Ø)
                    closedOrders.push({
                        ...order,
                        orderKey: key,
                        total: orderTotal,
                        confirmed: order.payment_confirmed
                    });
                } else {
                    // ‘±’Ø’ø’´’æ/’¢’°÷Å ’∫’°’ø’æ’•÷Ä’∂’•÷Ä (’é’•÷Ä’´’∂ ’°’≤’µ’∏÷Ç’Ω’°’Ø)
                    
                    const currentGroup = ordersGroupedByTable[order.table];
                    
                    if (!currentGroup) {
                         ordersGroupedByTable[order.table] = {
                            totalAmount: 0,
                            batches: [],
                            paymentInfo: { method: order.payMethod, time: order.payTime },
                            confirmed: order.payment_confirmed, 
                        };
                    }

                    ordersGroupedByTable[order.table].totalAmount += orderTotal;
                    ordersGroupedByTable[order.table].batches.push(order); 
                    
                    // ‘π‘±’ê’Ñ‘±’ë’Ü’à’í’Ñ ‘µ’Ü’î ‘Ω’Ñ‘≤‘ª ’é’É‘±’ê’Ñ‘±’Ü ‘ø‘±’ê‘≥‘±’é‘ª’É‘±‘ø‘∏
                    // ‘µ’©’• ’£’∏’∂’• ’¥’•’Ø ’¢’°÷Å ’∫’°’ø’æ’•÷Ä ’π’´ ’∞’°’Ω’ø’°’ø’æ’•’¨, ’°’∫’° ’≠’∏÷Ç’¥’¢’® ’∞’°’¥’°÷Ä’æ’∏÷Ç’¥ ’ß ’π’∞’°’Ω’ø’°’ø’æ’°’Æ
                    if (!order.payment_confirmed) {
                         ordersGroupedByTable[order.table].confirmed = false;
                    }
                }
            }
            
            // ’é’´’≥’°’Ø’°’£÷Ä’∏÷Ç’©’µ’°’∂ ’©’°÷Ä’¥’°÷Å’∏÷Ç’¥’® UI-’∏÷Ç’¥
            document.getElementById('totalSales').innerText = `${totalSales.toLocaleString()} ÷è`;
            document.getElementById('totalCount').innerText = totalCount;
            document.getElementById('avgCheck').innerText = totalCount > 0 ? `${Math.round(totalSales / totalCount).toLocaleString()} ÷è` : '0 ÷è';
            document.getElementById('cashSales').innerText = `${cashSales.toLocaleString()} ÷è`;
            document.getElementById('cardSales').innerText = `${cardSales.toLocaleString()} ÷è`;


            if (currentRole === 'cashier') {
                renderOpenOrdersTable(ordersGroupedByTable); 
                renderClosedOrdersTable(closedOrders);       
            }
        }

        // --- ‘≤‘±’ë ’ä‘±’è’é‘µ’ê’Ü‘µ’ê‘ª ‘±’Ç’Ö’à’í’ç‘±‘ø‘ª ’ë’à’í’ë‘±‘¥’ê’à’í’Ñ (‘Ω’¥’¢’°’æ’∏÷Ä’æ’°’Æ ’®’Ω’ø ’Ω’•’≤’°’∂’´) ---
        function renderOpenOrdersTable(groupedOrders) {
            const tbody = document.getElementById('openOrdersTableBody');
            tbody.innerHTML = '';

            const tableNumbers = Object.keys(groupedOrders).sort((a, b) => parseInt(a) - parseInt(b));

            tableNumbers.forEach(tNum => {
                const group = groupedOrders[tNum];
                
                // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ’ù ’°÷Ä’§’µ’∏÷Ñ ’°’µ’Ω ’Ω’•’≤’°’∂’´ ’¢’∏’¨’∏÷Ä ’¢’°÷Å ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® ’∞’°’Ω’ø’°’ø’æ’°’Æ ’•’∂
                const isEveryOpenOrderConfirmed = group.batches.every(order => order.payment_confirmed === true);

                // ‘Ω’∏’∞’°’∂’∏÷Å’´ ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø
                let statusText = '‚è≥ ‘∏’∂’©’°÷Å÷Ñ’´ ’¥’•’ª';
                let statusClass = '';

                if (group.batches.some(b => b.status_kitchen_done && !b.status_kitchen_closed)) {
                     statusText = 'üçΩÔ∏è ’ä’°’ø÷Ä’°’Ω’ø ‘∑! (’è’°÷Ä’•÷Ñ)';
                     statusClass = 'style="color: #007bff; font-weight: bold;"';
                }
                
                // ’é’≥’°÷Ä’¥’°’∂ ‘ø’°÷Ä’£’°’æ’´’≥’°’Ø
                const paymentStatus = isEveryOpenOrderConfirmed 
                    ? '<span style="color: green; font-weight: bold;">’é’≥’°÷Ä’æ’°’Æ ’ß</span>'
                    : '<span style="color: red;">’â’æ’≥’°÷Ä’æ’°’Æ ’ß</span>';

                tbody.innerHTML += `
                    <tr>
                        <td>#${tNum}</td>
                        <td><div class="total-amount">${group.totalAmount.toLocaleString()} ÷è</div></td>
                        <td>${group.paymentInfo.method} (${group.paymentInfo.time})</td>
                        <td ${statusClass}>${statusText}</td>
                        <td>${paymentStatus}</td>
                    </tr>
                `;
            });
        }
        
        // --- ’ì‘±‘ø’é‘±‘æ ’ä‘±’è’é‘µ’ê’Ü‘µ’ê‘ª ‘±’Ç’Ö’à’í’ç‘±‘ø‘ª ’ë’à’í’ë‘±‘¥’ê’à’í’Ñ ---
        function renderClosedOrdersTable(closedOrders) {
            const tbody = document.getElementById('closedOrdersTableBody');
            tbody.innerHTML = '';

            // ‘¥’°’Ω’°’æ’∏÷Ä’•’¨ ’™’°’¥’°’∂’°’Ø’°’£÷Ä’°’Ø’°’∂ ’Ø’°÷Ä’£’∏’æ
            closedOrders.sort((a, b) => b.timestamp - a.timestamp);

            closedOrders.forEach(order => {
                const time = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                // ’ï’£’ø’°’£’∏÷Ä’Æ’∏÷Ç’¥ ’•’∂÷Ñ ’¥’´’°’µ’∂ payment_confirmed ’§’°’∑’ø’®
                const confirmationHTML = order.confirmed ? `<span style="color: green; font-weight: bold;">‚úÖ ‘±’µ’∏</span>` : `<span style="color: red; font-weight: bold;">‚ùå ’à’π</span>`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${time}</td>
                        <td>#${order.table}</td>
                        <td>${order.total.toLocaleString()} ÷è</td>
                        <td>${order.payMethod}</td>
                        <td>${confirmationHTML}</td>
                    </tr>
                `;
            });
        }

        // --- ’é’É‘±’ê’à’í’Ñ‘∏ ’Ä‘±’ç’è‘±’è‘µ‘º’à’í ’ñ’à’í’Ü‘ø’ë‘ª‘± (’ç’•’≤’°’∂’´ ‘≤’∏’¨’∏÷Ä ’â’∞’°’Ω’ø’°’ø’æ’°’Æ ’ä’°’ø’æ’•÷Ä’∂’•÷Ä’´ ’∞’°’¥’°÷Ä) ---
        function confirmPaymentForTable(tableNum) {
             if (!confirm(`’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’ç’•’≤’°’∂ ${tableNum}-’´ ’¢’∏’¨’∏÷Ä ’π’∞’°’Ω’ø’°’ø’æ’°’Æ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’´ ’æ’≥’°÷Ä’∏÷Ç’¥’® ’Ω’ø’°÷Å’æ’°’Æ ’ß÷â`)) {
                 return;
             }
             
             // ’î’°’∂’´ ’∏÷Ä orderByChild-’® ’π’´ ’°’∑’≠’°’ø’∏÷Ç’¥, ’¥’•’∂÷Ñ ’Ø’Ø’°÷Ä’§’°’∂÷Ñ ’¢’∏’¨’∏÷Ä ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® ÷á ’Ø÷Ü’´’¨’ø÷Ä’•’∂÷Ñ JS-’∏÷Ç’¥:
             // ‘ø‘±’ê‘µ’é’à’ê: ’Ñ’•’∂÷Ñ ’°’∑’≠’°’ø’∏÷Ç’¥ ’•’∂÷Ñ Firebase-’´÷Å ’Ω’ø’°÷Å’æ’°’Æ ’ø’æ’µ’°’¨’∂’•÷Ä’´ ’∞’•’ø (allOrders),
             // ’¢’°’µ÷Å ’°’∂’∞÷Ä’°’™’•’∑’ø ’ß ’Ø’°’ø’°÷Ä’•’¨ ’∏÷Ç’≤’´’≤ ’Ø’°’∂’π, ’•’©’• ’Ø’∏’§’® ’π’´ ’©’°÷Ä’¥’°÷Å’∂’∏÷Ç’¥÷â
             
             db.ref('orders').once('value')
             .then(snapshot => {
                const firebaseUpdates = {}; 
                
                snapshot.forEach(childSnapshot => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();

                    // 1. ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’∏÷Ä ’§’° ’¥’•÷Ä ’Ω’•’≤’°’∂’∂ ’ß
                    // 2. ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ, ’∏÷Ä ’§’° ’°’∫÷Ä’°’∂÷Ñ’°’µ’´’∂ ’∫’°’ø’æ’•÷Ä ’ß ÷á ’§’•’º ’∞’°’Ω’ø’°’ø’æ’°’Æ ’π’ß
                    if (data.table == tableNum && !data.payment_confirmed && data.items && data.items.length > 0) {
                        
                        // ‘≤‘±’ë‘±’ê’Å‘±‘ø ’à’í’Ç‘ª
                        firebaseUpdates[`orders/${key}/payment_confirmed`] = true;
                        firebaseUpdates[`orders/${key}/payment_confirmed_time`] = Date.now();
                    }
                });

                if (Object.keys(firebaseUpdates).length > 0) {
                    // ‘±’Ö’ç ‘≥’à’ê‘æ’à’Ç’à’í‘π’Ö’à’í’Ü‘∏ ‘±’ä‘±’Ä’à’é’à’í’Ñ ‘∑ ‘π‘±’ê’Ñ‘±’ë’à’í’Ñ‘∏
                    return db.ref().update(firebaseUpdates); 
                }
                
                // ‘µ’©’• ’°’µ’Ω ’Ω’•’≤’°’∂’´ ’∞’°’¥’°÷Ä ’¢’°÷Å ’∫’°’ø’æ’•÷Ä’∂’•÷Ä ’π’•’∂ ’£’ø’∂’æ’•’¨
                alert(`’ç’•’≤’°’∂ ${tableNum}-’´ ’∞’°’¥’°÷Ä ’π’∞’°’Ω’ø’°’ø’æ’°’Æ ’∫’°’ø’æ’•÷Ä’∂’•÷Ä ’π’£’ø’∂’æ’•÷Å’´’∂÷â`);
                return Promise.resolve();
             })
             .then(() => {
                 // ’î’°’∂’´ ’∏÷Ä ’©’°÷Ä’¥’°÷Å’∏÷Ç’¥’® ’Ø’°’ø’°÷Ä’æ’∏÷Ç’¥ ’ß, filterAndRender-’® ’°’æ’ø’∏’¥’°’ø ’Ø’°’∑’≠’°’ø’´÷â
                 // ‘º÷Ä’°÷Å’∏÷Ç÷Å’´’π alert-’® ’Ø’∞’°’∂’•’∂÷Ñ, ÷Ñ’°’∂’´ ’∏÷Ä ’°’µ’∂ ’°÷Ä’§’•’∂ ’ø’•’≤’´ ’ß ’∏÷Ç’∂’•÷Å’•’¨ ’æ’•÷Ä÷á’∏÷Ç’¥
                 
                 // ‘±’∂’∞÷Ä’°’™’•’∑’ø ’ß ’¨÷Ä’°÷Å’∏÷Ç÷Å’´’π ’©’°÷Ä’¥’°÷Å’∏÷Ç’¥ ’Ø’°’ø’°÷Ä’•’¨, ’•’©’• Firebase-’´ ’¨’Ω’∏’≤’® ’±’°’≠’∏’≤’æ’´
                 fetchData(); 
             })
             .catch(error => {
                alert(`’ç’≠’°’¨ ’æ’≥’°÷Ä’∏÷Ç’¥’® ’∞’°’Ω’ø’°’ø’•’¨’´’Ω: ${error.message}`);
                console.error("Payment Confirmation Error:", error);
             });
        }
        
        // --- ‘ø’ê‘ª’è‘ª‘ø‘±‘ø‘±’Ü ’Ä‘±’ê’ë’à’í’Ñ’Ü‘µ’ê‘ª ‘º’à‘≥‘ª‘ø‘± (‘ø‘±’ç’ç‘±’Ö‘ª ’Ä‘±’Ñ‘±’ê) ---
        
        function showNotification(body, role) {
            if (Notification.permission === 'granted') {
                const title = role === 'kitchen' ? '‘Ω’∏’∞’°’∂’∏÷Å PRO' : '‘ø’°’Ω’Ω’° PRO';
                new Notification(title, { body: body });
            }
        }
        function playSound() {
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
            audio.play().catch(e=>{});
        }

        // ’ñ’∏÷Ç’∂’Ø÷Å’´’°, ’∏÷Ä’® ’¨’Ω’∏÷Ç’¥ ’ß ’¢’∏’¨’∏÷Ä ’∫’°’ø’æ’•÷Ä’∂’•÷Ä’® ÷á ÷Ü’´’¨’ø÷Ä’∏÷Ç’¥ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®
        function listenForCriticalOrders() {
            db.ref('orders').on('value', (snapshot) => {
                const requests = [];
                let hasNewRequest = false;
                
                snapshot.forEach(childSnapshot => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();
                    const items = data.items || [];
                    const firstItemName = items.length > 0 ? items[0].name : '';
                    
                    const isBillRequest = firstItemName.includes("‘Ω’Ü‘¥’ê’à’í’Ñ ‘µ’Ü ’Ä‘±’á‘ª’é‘∏");
                    const isCallRequest = firstItemName.includes("‘ø‘±’Ü’â’à’í’Ñ ‘µ’Ü ’Ñ‘±’è’à’í’ë’à’Ç‘ª’Ü");

                    // ’ë’∏÷Ç÷Å’°’§÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’¥’´’°’µ’∂ ’π÷É’°’Ø’æ’°’Æ ’∞’°’∑’´’æ/’Ø’°’∂’π ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®
                    if ((isBillRequest || isCallRequest) && !data.status_kitchen_closed) {
                        requests.push({ key, data });
                        
                        // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ’ù ’°÷Ä’§’µ’∏÷Ñ ’∂’∏÷Ä ’ß (admin_viewed ’§’°’∑’ø’´ ’¢’°÷Å’°’Ø’°’µ’∏÷Ç’©’µ’°’¥’¢)
                        if (!data.admin_viewed) {
                            hasNewRequest = true;
                            
                            // ‘±’Ü’Ñ‘ª’ã‘±‘ø‘±’Ü ‘æ‘±’Ü’à’í’ë’à’í’Ñ ‘≤’ê‘±’à’í‘∂‘µ’ê’à’í’Ñ
                            const type = isBillRequest ? '’Ä‘±’á‘ª’é' : '’Ñ‘±’è’à’í’ë’à’Ç‘ª ‘ø‘±’Ü’â';
                            showNotification(`‚ö†Ô∏è ’ç‘µ’Ç‘±’Ü #${data.table}: ${type}`, 'cashier');
                            
                            // ’Ü’∑’∏÷Ç’¥ ’•’∂÷Ñ ’∏÷Ä’∫’•’Ω ’§’´’ø’æ’°’Æ, ’∏÷Ä’∫’•’Ω’¶’´ ’¥’´’°’µ’∂ ’¥’•’Ø ’°’∂’£’°’¥ ’°’∞’°’¶’°’∂’£’´
                            db.ref(`orders/${key}`).update({ admin_viewed: true }); 
                        }
                    }
                });
                
                if (hasNewRequest) {
                    playSound();
                }

                // 3. ’ë’à’í’ë‘±‘ø‘ª ‘π‘±’ê’Ñ‘±’ë’à’í’Ñ
                renderCriticalRequests(requests);
            });
        }
        
        // ’ñ’∏÷Ç’∂’Ø÷Å’´’°, ’∏÷Ä’® ’∂’Ø’°÷Ä’∏÷Ç’¥ ’ß ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’´ ÷Å’∏÷Ç÷Å’°’Ø’®
        function renderCriticalRequests(requests) {
            const container = document.getElementById('criticalRequestsList');
            container.innerHTML = '';
            
            // ‘¥’°’Ω’°’æ’∏÷Ä’∏÷Ç’¥ ’•’∂÷Ñ ’™’°’¥’°’∂’°’Ø’°’£÷Ä’°’Ø’°’∂ ’Ø’°÷Ä’£’∏’æ (’°’¥’•’∂’°’∞’´’∂’®’ù ’æ’•÷Ä÷á’∏÷Ç’¥)
            requests.sort((a, b) => a.data.timestamp - b.data.timestamp);

            if (requests.length === 0) {
                 container.innerHTML = '<p style="color:#856404;">‘±’Ø’ø’´’æ ’Ø÷Ä’´’ø’´’Ø’°’Ø’°’∂ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä ’π’Ø’°’∂÷â</p>';
                 return;
            }

            requests.forEach(req => {
                const type = req.data.items[0].name.includes("‘Ω’Ü‘¥’ê’à’í’Ñ ‘µ’Ü ’Ä‘±’á‘ª’é‘∏") ? '’Ä‘±’á‘ª’é' : '‘ø‘±’Ü’â';
                const icon = type === '’Ä‘±’á‘ª’é' ? 'üßæ' : 'üîî';
                const bgColor = type === '’Ä‘±’á‘ª’é' ? '#ffc107' : '#dc3545';
                const comment = req.data.comment || '';
                const time = new Date(req.data.timestamp).toLocaleTimeString();
                
                container.innerHTML += `
                    <div style="padding: 15px; background: ${bgColor}; color: white; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-size: 20px; font-weight: bold;">${icon} ${type} ’ç’•’≤’°’∂ #${req.data.table}</span>
                            <div style="font-size: 14px; margin-top: 5px;">${comment} (${time})</div>
                        </div>
                        <button onclick="markRequestAsDone('${req.key}')" 
                                style="background: white; color: ${bgColor}; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ‚úÖ ‘ø’°’ø’°÷Ä’æ’°’Æ ’ß
                        </button>
                    </div>
                `;
            });
        }
        
        // ’Ñ’•’Ø ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’Ø’°’ø’°÷Ä’æ’°’Æ ’∂’∑’•’¨’∏÷Ç ÷Ü’∏÷Ç’∂’Ø÷Å’´’° (÷É’°’Ø’∏÷Ç’¥ ’ß ’∫’°’ø’æ’•÷Ä’®)
        function markRequestAsDone(key) {
             if (confirm("’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’°’µ’Ω ’∞’°÷Ä÷Å’∏÷Ç’¥’® ’Ø’°’ø’°÷Ä’æ’°’Æ ’ß÷â")) {
                 // ’ì’°’Ø’∏÷Ç’¥ ’•’∂÷Ñ ’°’µ’∂’∫’•’Ω, ’´’∂’π’∫’•’Ω ‘Ω’∏’∞’°’∂’∏÷Å’´ ’ä’°’ø’æ’•÷Ä’∂’•÷Ä’®, ’¢’°’µ÷Å ’°’µ’Ω ’§’•’∫÷Ñ’∏÷Ç’¥ Cashier-’∂ ’ß ÷É’°’Ø’∏÷Ç’¥
                 db.ref('orders/' + key).update({ status_kitchen_closed: true, admin_closed_time: Date.now() })
                 .then(() => {
                     alert("’Ä’°÷Ä÷Å’∏÷Ç’¥’® ÷É’°’Ø’æ’•÷Å÷â");
                 });
             }
        }
        
        // ‘≤’∏’¨’∏÷Ä ’°’Ø’ø’´’æ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’® ’¥’°÷Ñ÷Ä’•’¨’∏÷Ç ÷Ü’∏÷Ç’∂’Ø÷Å’´’°
        function clearCriticalRequests() {
             if (!confirm("’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ÷Å’°’∂’Ø’°’∂’∏÷Ç’¥ ’•÷Ñ ’¥’°÷Ñ÷Ä’•’¨ ’¢’∏’¨’∏÷Ä ’°’Ø’ø’´’æ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®÷â")) {
                 return;
             }
             
             db.ref('orders').once('value', (snapshot) => {
                 const updates = {};
                 snapshot.forEach(childSnapshot => {
                     const data = childSnapshot.val();
                     const firstItemName = data.items[0].name;

                     const isBillOrCall = firstItemName.includes("‘Ω’Ü‘¥’ê’à’í’Ñ ‘µ’Ü ’Ä‘±’á‘ª’é‘∏") || firstItemName.includes("‘ø‘±’Ü’â’à’í’Ñ ‘µ’Ü ’Ñ‘±’è’à’í’ë’à’Ç‘ª’Ü");

                     // ’ì’°’Ø’∏÷Ç’¥ ’•’∂÷Ñ ’¥’´’°’µ’∂ ’π÷É’°’Ø’æ’°’Æ ’∞’°’∑’´’æ/’Ø’°’∂’π ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®
                     if (isBillOrCall && !data.status_kitchen_closed) {
                         updates[`${childSnapshot.key}/status_kitchen_closed`] = true;
                         updates[`${childSnapshot.key}/admin_closed_time`] = Date.now();
                     }
                 });

                 if (Object.keys(updates).length > 0) {
                     // ’à÷Ç’≤’≤’∏÷Ç’¥ ’•’∂÷Ñ updates object-’®
                     let finalUpdates = {};
                     for (const key in updates) {
                          finalUpdates[`orders/${key}`] = updates[key];
                     }

                     db.ref().update(finalUpdates)
                     .then(() => alert("‘≤’∏’¨’∏÷Ä ’°’Ø’ø’´’æ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’® ’¥’°÷Ñ÷Ä’æ’•÷Å’´’∂÷â"));
                 } else {
                     alert("‘±’Ø’ø’´’æ ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä ’π’Ø’°’∂ ’¥’°÷Ñ÷Ä’•’¨’∏÷Ç ’∞’°’¥’°÷Ä÷â");
                 }
             });
        }
        
        // --- ’ä‘±’è’ê‘±’ç’è ’à’í’è‘µ’ç’è’Ü‘µ’ê‘ª ‘º’à‘≥‘ª‘ø‘± (‘ø‘±’ç’ç‘±’Ö‘ª ’Ä‘±’Ñ‘±’ê) ---

        function listenForReadyOrders() {
            db.ref('orders').on('value', (snapshot) => {
                const readyItems = [];
                snapshot.forEach(childSnapshot => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();
                    
                    // ’ç’ø’∏÷Ç’£’∏÷Ç’¥ ’•’∂÷Ñ’ù ’°÷Ä’§’µ’∏÷Ñ ’∫’°’ø’æ’•÷Ä’® ’∫’°’ø÷Ä’°’Ω’ø ’ß ‘Ω’∏’∞’°’∂’∏÷Å’´ ’Ø’∏’≤’¥’´÷Å, 
                    // ÷á ’§’•’º÷á’Ω ’π’´ ÷É’°’Ø’æ’•’¨ (’°’µ’Ω’´’∂÷Ñ’∂’ù ’π’´ ’¥’°’ø’∏÷Ç÷Å’æ’•’¨ ’¥’°’ø’∏÷Ç÷Å’∏’≤’´ ’Ø’∏’≤’¥’´÷Å)÷â
                    if (data.status_kitchen_done && !data.status_kitchen_closed) {
                        
                        // ’ñ’´’¨’ø÷Ä’∏÷Ç’¥ ’•’∂÷Ñ service ’∞’°÷Ä÷Å’∏÷Ç’¥’∂’•÷Ä’®
                        const isServiceRequest = data.items.some(item => 
                            item.name.includes("’Ä‘±’á‘ª’é") || item.name.includes("‘ø‘±’Ü’â") || item.name.includes("’Ä‘±’ê’ë’Ü’à’í’Ñ")
                        );
                        
                        if (!isServiceRequest) {
                            readyItems.push({ key, data });
                        }
                    }
                });
                
                renderReadyOrders(readyItems);
            });
        }
        
        // ’ë’à’í’ë‘±‘¥’ê’Ñ‘±’Ü ’ñ’à’í’Ü‘ø’ë‘ª‘±
        function renderReadyOrders(readyItems) {
            const container = document.getElementById('readyOrdersList');
            container.innerHTML = '';
            
            if (readyItems.length === 0) {
                container.innerHTML = '<p style="color:#1a4d2e;">‘±’µ’Ω ’∫’°’∞’´’∂ ’∫’°’ø÷Ä’°’Ω’ø ’∏÷Ç’ø’•’Ω’ø’∂’•÷Ä ’π’Ø’°’∂:</p>';
                return;
            }
            
            // ‘¥’°’Ω’°’æ’∏÷Ä’•’¨ ’Ω’•’≤’°’∂’∏’æ ÷á ’™’°’¥’°’∂’°’Ø’∏’æ
            readyItems.sort((a, b) => a.data.table - b.data.table || a.data.timestamp - b.data.timestamp);

            readyItems.forEach(item => {
                const order = item.data;
                const itemList = order.items.map(i => `<li>${i.name} (x${i.qty})</li>`).join('');
                const time = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                container.innerHTML += `
                    <div style="padding: 15px; border-bottom: 1px dashed #c8e6c9; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <span style="font-size: 20px; font-weight: bold; color: #1a4d2e;">üçΩÔ∏è ’ç’•’≤’°’∂ #${order.table}</span>
                            <small style="color:#777; margin-left: 10px;">’ä’°’ø’æ’´÷Ä’æ’•’¨ ’ß ${time}</small>
                            <ul style="list-style-type: disc; padding-left: 20px; margin: 5px 0 0 0; font-size: 15px;">
                                ${itemList}
                            </ul>
                            ${order.comment ? `<p style="font-style: italic; font-size: 13px; color:#555; margin: 5px 0 0 0;">’Ü’∑’∏÷Ç’¥: ${order.comment}</p>` : ''}
                        </div>
                        <button onclick="markOrderAsServed('${item.key}')" 
                                style="background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex-shrink: 0;">
                            ’è’°÷Ä’° ’Ω’•’≤’°’∂
                        </button>
                    </div>
                `;
            });
        }
        
        // ’à÷Ç’è‘µ’ç’è‘∏ ’Ñ‘±’è’à’í’ë’é‘±‘æ ’Ü’á‘µ‘º’à’í ’ñ’à’í’Ü‘ø’ë‘ª‘±
        function markOrderAsServed(key) {
             if (confirm("’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’°’µ’Ω ’∏÷Ç’ø’•’Ω’ø’∂’•÷Ä’® ’¥’°’ø’∏÷Ç÷Å’æ’•’¨ ’•’∂ ’Ω’•’≤’°’∂’´’∂÷â")) {
                 // ’ì’°’Ø’∏÷Ç’¥ ’•’∂÷Ñ ’∫’°’ø’æ’•÷Ä’® (status_kitchen_closed)
                 db.ref('orders/' + key).update({ 
                     status_kitchen_closed: true, 
                     served_time: Date.now()
                 })
                 .then(() => {
                     alert("’ä’°’ø’æ’•÷Ä’® ’∂’∑’æ’•÷Å ’∏÷Ä’∫’•’Ω ’¥’°’ø’∏÷Ç÷Å’æ’°’Æ÷â");
                 });
             }
        }
    </script>
</body>
</html>